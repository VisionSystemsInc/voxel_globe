{% extends "main/base.html" %}
{% load staticfiles %}

{% block title %}Voxel Globe - Add files{% endblock %}

{% block includes %}

<link rel="stylesheet" href="{% static 'fileUpload/css/style.css' %}">
<link rel="stylesheet" href="{% static 'fileUpload/css/jquery.fileupload.css' %}">
<link rel="stylesheet" href="{% static 'fileUpload/css/jquery.fileupload-ui.css' %}">

<script src="{% static 'fileUpload/js/jquery.fileupload.js' %}"></script>
<script src="{% static 'fileUpload/js/jquery.fileupload-process.js' %}"></script>
<style>

.uploadEntry {
	display: block;
  vertical-align: top;
}

.pendingUpload {
  list-style-image: url({% static 'icons/' %}upload_pending.png);
}
    
</style>
{% endblock %}

{%block globalfunctions %}
// Global functions defined outside of the jquery document ready function can be put here.
{% endblock %}

{% block javascript %}

var pendingUpload = [];
var failedFiles = [];
var pendingIcon = "{% static 'icons/' %}" + "upload_pending.png";
var progressIcon = "{% static 'icons/' %}" + "upload_progress.png";
var successIcon = "{% static 'icons/' %}" + "upload_success.png";
var failIcon = "{% static 'icons/' %}" + "upload_fail.png";
var url = '{% url "ingest_controlpoint:uploadEndpoint" %}'
var successesHad = 0;
var successesNeeded = 0;
var batchSize = 25;

$( "#processButton" ).button({
  disabled: true
});
            
$('#fileupload').fileupload({
  url : url,
  dataType : 'html',
  autoUpload: false,
  // sequentialUploads: true
});

// remove non-alphanumeric characters from the input (for use in CSS ids)
function prettify(input) {
  return input.replace(/\W/g, '');
}

function onAdd(e, data) {
  console.log("Adding image for upload...");
  successesNeeded += 1;
  pendingUpload.push(data);

  data.context = $('<div class="uploadEntry"/>').appendTo('#selectedImages');

  var img = $('<img class="file-icon" id="icon' + prettify(data.files[0].name) + '" src="' + pendingIcon + '"/>');
  var node = $('<div/>')
    .append(img)
    .append($('<span/>').text(data.files[0].name));

  node.appendTo(data.context);
  data.node = node;
}

function onSubmit(e, data) {
  console.log(data.files[0].name + " submitted...");
}

function onDone(e, data) {
  for (var i = 0; i < data.files.length; i++) {
    console.log(data.files[i].name + " done...");
    $('#icon' + prettify(data.files[i].name)).prop("src", successIcon);
    successesHad += 1;

    if (successesNeeded != 0 && successesHad == successesNeeded) {
      $( "#processButton" ).button({
        disabled: false
      });
      pendingUpload = [];
      successesHad = 0;
      successesNeeded = 0;
      return;
    }
  }
  ingest(successesHad);
}

function onFail(e, data) {
  console.log(data.files[0].name + " failed...");
  $('#icon' + prettify(data.files[0].name)).prop("src", failIcon);
  failedFiles.push(data);
}

function ingest(startIndex) {
  var filesList = [];

  // add all the files in the batch to filesList and set their icons to progressIcon
  for (var i = startIndex; i < startIndex + batchSize && i < pendingUpload.length; i++) {
    $('#icon' + prettify(pendingUpload[i].files[0].name)).prop("src", progressIcon);
    filesList.push(pendingUpload[i].files[0]);
  }

  jqXHR = $('#fileupload').fileupload('send', {files: filesList});
}

var jqXHR = $('#fileupload').fileupload('enable')
  .on('fileuploadadd', onAdd)
  .on('fileuploadsubmit', onSubmit)
  .on('fileuploaddone', onDone)
  .on('fileuploadfail', onFail);

        
$('#fakeUpload').click(function (e) {
  $( "#processButton" ).button({
    disabled: true
  });
	$('#fileupload').click();	
})

$('#doIngest').click(function (e) {
  if (failedFiles.length != 0) {
    $('#fileupload').fileupload('send', {files: failedFiles});
  }

  // if there are no files pending upload, do nothing
  if (pendingUpload.length == 0) {
    return;
  }

  // call the ingest function with starting index 0
  ingest(successesHad);
});

$('#clearButton').click(function (e) {
  // if an upload is in progress, abort it
  if (jqXHR) {
    jqXHR.abort();
  }

  // reset the pendingUpload list and the DOM list
  pendingUpload = [];
  $('#selectedImages').html("");

  // disable the process button (since there are no files to process)
  $( "#processButton" ).button({
    disabled: true
  });
});

$('#processButton').click(function (e) {
  document.forms['ingestfolder'].submit()
  //AEN: Yeah, I don't know your jquery magic
});

{% endblock %}

{% block pageTitle %}<h2>Voxel Globe - Add Files</h2> {% endblock %}

{% block content %}
<div id="mainContainer" class="main-content">

<h1>Add files for {{ uploadSession.name }}</h1>

   <div id="page2" style="margin: 0px 20px; padding: 0px;  overflow:auto;">
            <div style="display:block; min-width:800px; width:auto;">
             <!-- <div style="width:auto; height: auto; overflow: hidden;" ondragover="allowDrop(event)" ondrop="drop(event)"> -->
                    <div>
						Drag and drop image files onto this page to upload the images and files to the server.
                    </div>
                    <p>
                    <form action="{% url "ingest_controlpoint:uploadEndpoint" %}" name="filedropform" method="post" enctype="multipart/form-data">
                      {% csrf_token %}
                        <input type="hidden" name="uploadSession" value="{{ uploadSession.id }}" />
                        <input type="hidden" name="directory" value="{{ directory.id }}" />
                        <input type="hidden" name="testFile" value="{{ testFile.id }}" />
                        <input id="fileupload" type="file" name="filedrop" style="display:none" multiple>
                    </form>
                    
                    <form action="{% url "ingest_controlpoint:ingestFolder" %}" name="ingestfolder" method="post">
                      {% csrf_token %}
                      <input type="hidden" name="uploadSession" value="{{ uploadSession.id }}" />
                    </form>
                   
                    <button id="fakeUpload" style="z-index: 10;">
                            Select files...
                    </button>
                    <div style="display:inline-block; width:50px;"> </div>
                    <button id="doIngest"
                  		  style="overflow: auto; z-index: 10;"
                   		  title="Upload files">Upload Selected Files
                    </button>
                    
                     <button id="clearButton"
                  		  style="overflow: auto; z-index: 10;"
                   		  title="Clear files">Clear Selected Files
                    </button>

                    <div style="display:inline-block; width:50px;"> </div>
                    <button id="processButton"
                        style="overflow: auto; z-index: 10;"
                        title="Process File">Process Uploaded Files
                    </button>
                    
                    <p>
                    <h3>Files Selected for Ingest</h3>
                    <div id="selectedImages" style="margin: 0px 20px; padding: 0px;">
                    </div>
		</div>
 </div>
 <div id="debugInfo">
</div>
{% endblock %}
