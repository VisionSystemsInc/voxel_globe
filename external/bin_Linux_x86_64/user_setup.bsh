#!/usr/bin/env bash

source $(dirname ${BASH_SOURCE[0]})/common_setup.env

echo "Creating user ${VIP_DAEMON_GROUP}"
${NEW_GROUP} ${VIP_DAEMON_GROUP}

for USER in ${VIP_HTTPD_DAEMON_USER} ${VIP_CELERY_DAEMON_USER} ${VIP_RABBITMQ_USER} ${VIP_POSTGRESQL_USER}
do
  echo "Creating user ${USER}"
  ${NEW_USER} -m -r -d ${VIP_DAEMON_HOME_DIR}/${USER} -g ${VIP_DAEMON_GROUP} -s /bin/bash ${USER}
  sed -i '/^\s*umask/d' ${VIP_DAEMON_HOME_DIR}/${USER}/.bashrc
  echo "umask 0002" >> ${VIP_DAEMON_HOME_DIR}/${USER}/.bashrc
  ${CHOWN} ${USER}:${VIP_DAEMON_GROUP} -R ${VIP_DAEMON_HOME_DIR}/${USER}
done

#RabbitMQ
echo "[rabbitmq_management]." > ${VIP_SYSCONFDIR}/rabbitmq/enabled_plugins
${CHOWN} -R ${VIP_RABBITMQ_USER}:${VIP_DAEMON_GROUP} ${VIP_RABBITMQ_MNESIA_BASE}/.erlang.cookie
${CHOWN} -R ${VIP_RABBITMQ_USER}:${VIP_DAEMON_GROUP} ${VIP_RABBITMQ_MNESIA_BASE}/rabbit*
${CHOWN} -R ${VIP_RABBITMQ_USER}:${VIP_DAEMON_GROUP} ${VIP_RABBITMQ_PID_DIR}
${CHOWN} -R ${VIP_RABBITMQ_USER}:${VIP_DAEMON_GROUP} ${VIP_RABBITMQ_LOCK_DIR}
${CHOWN} -R ${VIP_RABBITMQ_USER}:${VIP_DAEMON_GROUP} ${VIP_RABBITMQ_LOG_DIR}

#Celeryd
#${CHOWN} -R ${VIP_CELERY_USER}:${VIP_DAEMON_GROUP} ${VIP_PID_DIR}/celery* 
${CHOWN} -R ${VIP_CELERY_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_CELERY_PID_DIR}
${CHOWN} -R ${VIP_CELERY_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_CELERY_LOCK_DIR}
${CHOWN} -R ${VIP_CELERY_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_CELERY_LOG_DIR}

#Notebook - Should be owned by a normal user
${CHOWN} -R ${VIP_NOTEBOOK_DAEMON_USER}:${VIP_NOTEBOOK_DAEMON_GROUP} ${VIP_NOTEBOOK_PROFILE_DIR}
${CHOWN} -R ${VIP_NOTEBOOK_DAEMON_USER}:${VIP_NOTEBOOK_DAEMON_GROUP} ${VIP_NOTEBOOK_PID_DIR}
${CHOWN} -R ${VIP_NOTEBOOK_DAEMON_USER}:${VIP_NOTEBOOK_DAEMON_GROUP} ${VIP_NOTEBOOK_LOCK_DIR}
${CHOWN} -R ${VIP_NOTEBOOK_DAEMON_USER}:${VIP_NOTEBOOK_DAEMON_GROUP} ${VIP_NOTEBOOK_LOG_DIR}

#Httpd
${CHOWN} -R ${VIP_HTTPD_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_HTTPD_PID_DIR}
${CHOWN} -R ${VIP_HTTPD_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_HTTPD_LOCK_DIR}
${CHOWN} -R ${VIP_HTTPD_DAEMON_USER}:${VIP_DAEMON_GROUP} ${VIP_HTTPD_LOG_DIR}
${CHOWN} ${VIP_HTTPD_DAEMON_USER} ${VIP_HTTPD_SSL_KEY}
${CHMOD} 700 ${VIP_HTTPD_SSL_KEY}

#Postgresql
${CHOWN} -R ${VIP_POSTGRESQL_USER}:${VIP_DAEMON_GROUP} ${VIP_POSTGRESQL_PID_DIR}
${CHOWN} -R ${VIP_POSTGRESQL_USER}:${VIP_DAEMON_GROUP} ${VIP_POSTGRESQL_LOCK_DIR}
${CHOWN} -R ${VIP_POSTGRESQL_USER}:${VIP_DAEMON_GROUP} ${VIP_POSTGRESQL_LOG_DIR}
${CHOWN} -R ${VIP_POSTGRESQL_USER}:${VIP_DAEMON_GROUP} ${VIP_POSTGRESQL_DATABASE}

${CHOWN} :${VIP_DAEMON_GROUP} ${VIP_DATABASE_DIR}

#Image Server
${CHOWN} -R :${VIP_DAEMON_GROUP} ${VIP_IMAGE_SERVER_ROOT}
${CHMOD} -R g+rw ${VIP_IMAGE_SERVER_ROOT}
find ${VIP_IMAGE_SERVER_ROOT} -type d -exec chmod g+x {} \;

${CHOWN} :${VIP_DAEMON_GROUP} ${VIP_TEMP_DIR}
${CHOWN} :${VIP_DAEMON_GROUP} ${VIP_STORAGE_DIR}
