#!/usr/bin/env bash

# This is added just in case there is NO python available
# It shoudl work, but it not maintained code. Be careful, you may be fixing
# this in order to use it.

source $(dirname ${BASH_SOURCE[0]})/env.bsh

function checkpython()
{
  PYTHON_MAJOR=`python -c 'import sys;print(sys.version_info[0])' 2>/dev/null` || PYTHON_MAJOR=0
  PYTHON_MINOR=`python -c 'import sys;print(sys.version_info[1])' 2>/dev/null` || PYTHON_MINOR=0 
  if (( ${PYTHON_MAJOR} == 2 && ${PYTHON_MINOR} == 7 )); then
    return 0 #Success
  else
    return 1 #Failure
  fi  
}

function populate_roam()
{
  mkdir -p ${VIP_ROAM_DIR}
  echo '#!/bin/bash
BASE_DIR=$(dirname ${BASH_SOURCE[0]})/..
BASE_DIR=$(cd ${BASE_DIR}; pwd)
export PATH=${BASE_DIR}'${VIP_BINDIR_BASE}':${PATH}
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${BASE_DIR}'${VIP_LIBDIR_BASE}'
if [ "${BASH_SOURCE[0]}" == "$0" ]; then
  exec ${BASE_DIR}'${VIP_BINDIR_BASE}'/$(basename $0) "${@}"
else
  source ${BASE_DIR}'${VIP_BINDIR_BASE}'/$(basename ${BASH_SOURCE[0]}) "${@}"
fi' > ${VIP_ROAM_DIR}/roam
  chmod 755 ${VIP_ROAM_DIR}/roam
  ln -f ${VIP_INSTALL_DIR}/roam/roam ${VIP_INSTALL_DIR}/roam/python
}

if [ ! -e "${VIP_RPMSRC_DIR}" ]
then
  rpm --define "_topdir ${RPM_DIR}" --dbpath ${VIP_RPMDB_DIR}) --rebuilddb
fi

rm -f ${VIP_ROAM_DIR}/python #This will cause a noisy output if it it exists because common.inc calls python
export QA_RPATHS=0xFFFF 

#Build it
rpmbuild --nodeps --define "_topdir ${VIP_RPMSRC_DIR}" -bb ${VIP_RPMSRC_DIR}/SPECS/python.spec

#List of all RPMs generated by THAT spec file
rpms=( $(rpm --define "_topdir ${VIP_RPMSRC_DIR}" --dbpath ${VIP_RPMDB_DIR} --specfile ${VIP_RPMSRC_DIR}/SPECS/python.spec -q) )
rpm_files=( $(rpm --define "_topdir ${VIP_RPMSRC_DIR}" --dbpath ${VIP_RPMDB_DIR} --specfile ${VIP_RPMSRC_DIR}/SPECS/python.spec -q --qf "${VIP_RPMSRC_DIR}/RPMS/%{ARCH}/%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}.rpm\n") )
  
#uninstall them
for rpm in "${rpms[@]}"; do
  rpm --define "_topdir ${VIP_RPMSRC_DIR}" --dbpath ${VIP_RPMDB_DIR} -q --quiet ${rpm} && rpm --define "_topdir ${VIP_RPMSRC_DIR}" --dbpath ${VIP_RPMDB_DIR} --nodeps -ev ${rpm}
done
  
#install them
for rpm in "${rpm_files[@]}"; do
  rpm --define "_topdir ${VIP_RPMSRC_DIR}" --dbpath ${VIP_RPMDB_DIR} --nodeps -ihv ${rpm} --prefix "${VIP_INSTALL_DIR}"
done
populate_roam

#If it STILL can't be found, something is jacked up with the environment
if ! checkpython; then
  echo "I can't find the python I just built. Something is wrong"
  exit 1
fi
